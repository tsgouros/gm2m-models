<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>IC 443</title>
    <meta name="description" content="IC 443">
    <link href="../../style.css" rel="stylesheet">
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-render-order-component@1.1.0/dist/aframe-render-order-component.min.js"></script>
    <script type="text/javascript" src="./materials/override-ic443-ejecta-material.js"></script>
    <script type="text/javascript" src="./materials/override-ic443-torus-material.js"></script>
    <script type="text/javascript" src="./materials/override-ic443-blastwave-material.js"></script>
    <script type="text/javascript" src="./materials/override-ic443-nebula-material.js"></script>
    <script type="text/javascript" src="../../tourScripts/aframe-spritesheet-animation.js"></script>
    <style>
      /* By default, hide the DOM Overlay element. */
      #overlay {
          display: none;
      }
      /* Show the DOM Overlay element while active (:xr-overlay pseudoclass) */
      #overlay:xr-overlay {
          display: initial;
      }
      #exit-ar {
          position: absolute;
          right: 40px;
          bottom: 40px;
          background: rgba(127,127,127,0.25);
          color: white;
          border: 1px solid rgba(255,255,255,0.25);
          padding: 6px 8px;
          font-weight: bold;
      }
    </style>
    <script>
      AFRAME.registerComponent('exit-ar-button', {
        schema: {
            element: {type: 'selector'}
        },
        init: function () {
          this.data.element.addEventListener('click', ev => {
              this.el.sceneEl.renderer.xr.getSession().end();
          });
        }
      });
    </script>
    <script type="text/javascript" src="../../tourScripts/lookat.js"></script>
    <script type="text/javascript" src="../../tourScripts/multitouch-controls.js"></script>
    <script type="text/javascript" src="../../tourScripts/clickhandler.js"></script>
    <script type="text/javascript" src="../../tourScripts/ar-text.js"></script>
  </head>
  <!-- <body id="body" onload="multitouchInit()" style="touch-action:none"> -->
  <body>
    <div id="overlay">
      <button id="exit-ar">Exit AR</button>
    </div>
    <a-scene background="color: #111111"
              id="mainScene"
              render-order="background, nebula, clouds, ui, text">
      <a-entity exit-ar-button="element: #exit-ar"></a-entity>
      <a-assets> <!-- add the gltf models here -->
        <img id="sheet" src="../../textures/ar-click-sprite.png"/>
        <a-asset-item id="vignette" src="../../gltf/space-vignette.glb"></a-asset-item>
        <a-asset-item id="ic443Ejecta" src="../../gltf/ic443_ejecta.glb"></a-asset-item>
        <a-asset-item id="ic443Nebula" src="../../gltf/ic443_nebula.glb"></a-asset-item>
        <a-asset-item id="ic443Blastwave" src="../../gltf/ic443_blastwave.glb"></a-asset-item>
        <a-asset-item id="ic443Torus" src="../../gltf/ic443_torus.glb"></a-asset-item>
        <audio id="audio1" src="./audioAR/IC443.ogg" preload="auto"></audio>
        <audio id="audio2" src="./audioAR/IC443_moleculargascloud.ogg" preload="auto"></audio>
        <audio id="audio3" src="./audioAR/IC443_neutronstar.ogg" preload="auto"></audio>
        <audio id="audio4" src="./audioAR/IC443_shockwave.ogg" preload="auto"></audio>
        <audio id="audio5" src="./audioAR/IC443_starremains.ogg" preload="auto"></audio>
      </a-assets>
      <a-entity id="camera" camera="active: true" position="0 0 0" wasd-controls look-controls="pointerLockEnabled: true">
        <a-entity position="0 0 -0.05"
                geometry="primitive: ring; radiusInner: 0.0015; radiusOuter: 0.002;"
                material="color: #ccc; shader: flat;"
                animation__click="property: scale; startEvents: click; easing: easeInCubic; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1"
                animation__fusing="property: scale; startEvents: fusing; easing: easeInCubic; dur: 1500; from: 1 1 1; to: 0.1 0.1 0.1"
                animation__mouseleave="property: scale; startEvents: mouseleave; easing: easeInCubic; dur: 500; to: 1 1 1"
                cursor="fuse: true;"
                raycaster="objects: .clickable">
        </a-entity>
      </a-entity>

      <a-entity
        id="objs"
        scale="0.1 0.1 0.1"
        position="0 1 -1"
        rotation="0 0 0">
        
        <!-- AR text markers -->
        <a-entity 
          ar-text=" title: IC 443; 
                    description: A galactic supernova remnant also known as the 'Jellyfish Nebula';
                    audio: audio1;"
          position="1.86 7.55 0"
        ></a-entity>

        <a-entity 
          ar-text=" title: Molecular Gas Cloud; 
                    description: A ring-like cloud of molecular gas which slows down the shock wave and the star's remains;
                    audio: audio2;"
          position="0.68 5.2 0"
        ></a-entity>

        <a-entity 
          ar-text=" title: Neutron Star; 
                    description: The bright blue X-ray data likely contains a neutron star that formed from the collapse of another, massive star;
                    audio: audio3;"
          position="1.1 -2.2 -0.23"
        ></a-entity>

        <a-entity 
          ar-text=" title: Shock Wave; 
                    description: The shock wave of IC 443, similar to a sonic boom produced by a jet;
                    audio: audio4;"
          position="5.55 -3.42 -0.23"
        ></a-entity>

        <a-entity 
          ar-text=" title: Star Remains; 
                    description: The red and yellow colors of the star's remains indicate the velocities of their motion away from the center of the explosion;
                    audio: audio5;"
          position="5.03 0 0"
        ></a-entity>

<!--         <a-entity
          gltf-model="#vignette"
          id="vignette"
          render-order="background"
          look-at="[camera]"
          scale="10.0 10.0 10.0"
          position="2 0 2"
          material="opacity: 0.5; transparent: true"
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity> -->
        <a-entity
          gltf-model="#ic443Torus"
          id="ic443TorusEntity"
          override-ic443-torus-material
          render-order="clouds"
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity>
        <a-entity
          gltf-model="#ic443Blastwave"
          id="ic443BlastwaveEntity"
          override-ic443-blastwave-material
          render-order="clouds"
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity>
        <a-entity
          gltf-model="#ic443Nebula"
          id="ic443NebulaEntity"
          override-ic443-nebula-material
          render-order="nebula"
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity>
        <a-entity
          gltf-model="#ic443Ejecta"
          id="ic443EjectaEntity"
          override-ic443-ejecta-material
          render-order="nebula"
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity>
      </a-entity>
    </a-scene>

    <div id="splash">
      <div id="splash-inner">
        <div class="title">IC 443</div>
        <div id="go-button" onclick="pressStart()" style="display: none;">Start</div>
        <div class="sub-title">AR by <a href="https://www.nasa.gov/">NASA</a>,
        <a href="http://chandra.harvard.edu/">Chandra</a>, <br>
        <a href="https://www.cfa.harvard.edu/sao">SAO</a> &
        <a href="http://cs.brown.edu/people/faculty/tsgouros/">Brown CS</a></div>
      <br />
    </div>
      </div>
    </div>
    <script type="text/javascript">
    // This stuff is down here at the end because it has to run as soon as
    // all the a-frame assets are loaded.  It manages the splash screen shown
    // above, by pausing the action as soon as everything is loaded, and then by
    // executing .play() when the start button is pressed.

    // Pause action as soon as everything is loaded.
    document.getElementById("mainScene").addEventListener("loaded",
      function() {
        document.getElementById("go-button").style.display = "flex";
    });

    pressStart = function() {
      document.getElementById("splash").style.display = "none";
      document.getElementById("go-button").style.display = "none";

      // Load all the sounds and play-then-pause them all, to get them
      // permission to run under the iOS rules, which say that a sound
      // can only be played as a result of a user action.
      var sounds = document.getElementsByTagName('audio');

      for (i = 0; i < sounds.length; i++) {
        // console.log("playing, then pausing:", sounds[i]);
        var promise = sounds[i].play(); 

        if (promise) {
            //console.log("PLAYING:", promise);
            sounds[i].pause();
            sounds[i].currentTime = 0;

          promise.catch(function(e) { 
            console.log(e); 
            console.log(e.name); 
            console.log(e.message); 
            console.log(e.code); 
          });
        }      
      }
    }
  </script>
  </body>
</html>