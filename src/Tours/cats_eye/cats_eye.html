<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Cat's Eye</title>
    <link href="../../style.css" rel="stylesheet">
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v4.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://rawgit.com/protyze/aframe-curve-component/master/dist/aframe-curve-component.min.js"></script>
  <script src="https://rawgit.com/protyze/aframe-alongpath-component/master/dist/aframe-alongpath-component.min.js"></script>
    <script src="https://unpkg.com/aframe-render-order-component@1.1.0/dist/aframe-render-order-component.min.js"></script>
    <script type="text/javascript" src="../../tourScripts/index.js"></script>
    <script type="text/javascript" src="../../tourScripts/tour.js"></script>
    <script type="text/javascript" src="../../tourScripts/controller.js"></script>
    <script type="text/javascript" src="../../tourScripts/lookat.js"></script>
    <script type="text/javascript" src="./materials/override-catseye-outer.js"></script>
    <script type="text/javascript" src="./materials/override-catseye-inner.js"></script>
    <script type="text/javascript" src="./materials/override-catseye-xray.js"></script>
    <script type="text/javascript" src="./materials/override-catseye-sphere.js"></script>
  </head>
  <body>
    <a-scene id="mainScene"
             background="color: #FAFAFA"
             render-order="background, rainbow, xray, nebula, rainbowOverlay, text"
             >
    	<a-assets> <!-- add the gltf models here -->
        <img id="deepspace" src="../../textures/deepspace.png">
        <a-asset-item id="catseye_outer_nebula" src="../../gltf/catseye_outer_nebula.glb"></a-asset-item>
        <a-asset-item id="catseye_inner_nebula" src="../../gltf/catseye_inner_nebula.glb"></a-asset-item>
        <a-asset-item id="catseye_xray" src="../../gltf/catseye_xray.glb"></a-asset-item>
        <a-asset-item id="catseye_sphere" src="../../gltf/catseye_sphere.glb"></a-asset-item>
        <audio id="audio1" preload="auto" src="./audio/CatsEye_VR_Narration_01.mp3"></audio>
        <audio id="audio2" preload="auto" src="./audio/CatsEye_VR_Narration_02.mp3"></audio>
        <audio id="audio3" preload="auto" src="./audio/CatsEye_VR_Narration_03.mp3"></audio>
        <audio id="audio4" preload="auto" src="./audio/CatsEye_VR_Narration_04.mp3"></audio>
        <audio id="audio5" preload="auto" src="./audio/CatsEye_VR_Narration_05.mp3"></audio>
    	</a-assets>

      <a-sky src="#deepspace" render-order="background"></a-sky>

      <a-entity id="textHolder"
                    position="0 0 1000"
                    look-at="[camera]"
                    render-order="text"
                    text="width: 1; color: white; align: center;
                          anchor: center; side: double;
                          value: welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! welcome! ">
        </a-entity>

      <a-entity id="rig" rotation="0 0 0" position="0 0 0" wasd-controls look-controls="pointerLockEnabled: true" alongpath="curve: #seven; dur: 5000">
        <a-entity id="camera" camera="active: true" position="0 0 0"></a-entity>
        <!-- all tours go in here -->
        <a-entity id="controllerElement" controller sound="autoplay: false; volume: 0.75">
          <!-- naming convention: all lower case -->
          <a-curve id="one" tour="dur: 6000; pauseDuration: 7000; audio: audio1; text: In about 4 or 5 billion years, our Sun will run out of fuel and die.">
            <a-curve-point position="0.0 0.0 6.1"></a-curve-point>
            <a-curve-point position="0.0 0.0 5.3"></a-curve-point>
            <a-curve-point position="0.0 0.0 5.2"></a-curve-point>
          </a-curve>
          <a-curve id="two" tour="dur: 6000; pauseDuration: 11000; audio: audio2; text: As it does, it will enter into a phase like the one in the object known as the Cat's Eye Nebula, called a 'planetary nebula'.">
            <a-curve-point position="0.0 0.0 5.2"></a-curve-point>
            <a-curve-point position="1.5 -0.9 4.3"></a-curve-point>
            <a-curve-point position="1.6 -1.0 4.2"></a-curve-point>
          </a-curve>
          <a-curve id="three" tour="dur: 5000; pauseDuration: 12000; audio: audio3; text: In a planetary nebula, a dying star sheds its outer layers. The star (bright white object at center) illuminates the discarded material.">
            <a-curve-point position="1.6 -1.0 4.2"></a-curve-point>
            <a-curve-point position="-0.4 -0.2 3.7"></a-curve-point>
            <a-curve-point position="-0.5 -0.1 3.6"></a-curve-point>
          </a-curve>
          <a-curve id="four" tour="dur: 6000; pauseDuration: 11000; audio: audio4; text: A wind blowing from the central star rams into the ejected layers and pushes outward, creating spectacular filamentary structures.">
            <a-curve-point position="-0.5 -0.1 3.6"></a-curve-point>
            <a-curve-point position="0.1 1.2 3.4"></a-curve-point>
            <a-curve-point position="0.15 1.3 3.3"></a-curve-point>
          </a-curve>
          <a-curve id="five" tour="dur: 6000; pauseDuration: 10000; audio: audio5; text:  The winds or a blast wave from the star create bubbles that eventually evolve into the oblong shape and lobes around the star.">
            <a-curve-point position="0.15 1.3 3.3"></a-curve-point>
            <a-curve-point position="0.4 1.9 2.5"></a-curve-point>
            <a-curve-point position="0.5 2.0 2.4"></a-curve-point>
          </a-curve>
          <a-curve id="six" tour="dur: 8000; pauseDuration: 5000; text: ">
            <a-curve-point position="0.5 2.0 2.4"></a-curve-point>
            <a-curve-point position="-0.2 -0.2 5.5"></a-curve-point>
            <a-curve-point position="-0.3 -0.3 5.6"></a-curve-point>
          </a-curve>
          <a-curve id="seven" tour="dur: 6000; pauseDuration: 5000; text: ">
            <a-curve-point position="0.0 -0.2 2.0"></a-curve-point>
            <a-curve-point position="-0.0 -0.1 6.0"></a-curve-point>
            <a-curve-point position="0.0 0.0 6.1"></a-curve-point>
          </a-curve>
        </a-entity>
      </a-entity>

      <a-entity
        id="scaleAll"
        scale="0.5 0.5 0.5"
        position="0 0 0"
        rotation="0 180 0">
        <a-entity
          gltf-model="#catseye_outer_nebula"
          id="outer_nebula"
          override-catseye-outer="noiseAmt: 0.0;"
          render-order="nebula"
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity>
        <a-entity
          gltf-model="#catseye_inner_nebula"
          render-order="nebula"
          override-catseye-inner
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity>
        <a-entity
          gltf-model="#catseye_xray"
          render-order="nebula"
          override-catseye-xray
          renderer="antialias: true;
          colorManagement: true;
          physicallyCorrectLights: true;"></a-entity>

        <a-entity 
          gltf-model="#catseye_sphere"
          scale="1.2 1.2 1.2"
          look-at="[camera]"
          render-order="rainbow"
          override-catseye-sphere
          material="transparent: true; depthTest: false;"></a-entity>
        <a-entity 
          gltf-model="#catseye_sphere"
          scale="0.7 0.7 0.7"
          rotation="90 0 0 "
          translation="0 0 0.2"
          override-catseye-sphere="opacity: 0.35;"
          look-at="[camera]"
          render-order="rainbowOverlay"
          material="transparent: true; depthTest: false;"></a-entity>
      </a-entity>
      </a-entity>

    </a-scene>

    <div id="splash">
      <div id="splash-inner">
        <div class="title">Cat's Eye</div>
        <div id="go-button" onclick="pressStart()" style="display: none;">Start</div>
        <div class="sub-title">VR by <a href="https://www.nasa.gov/">NASA</a>,
        <a href="http://chandra.harvard.edu/">Chandra</a>, <br>
        <a href="https://www.cfa.harvard.edu/sao">SAO</a> &
        <a href="http://cs.brown.edu/people/faculty/tsgouros/">Brown CS</a></div>
      <br />
    </div>
      </div>
    </div>

    <script type="text/javascript">
    // This stuff is down here at the end because it has to run as soon as
    // all the a-frame assets are loaded.  It manages the splash screen shown
    // above, by pausing the action as soon as everything is loaded, and then by
    // executing .play() when the start button is pressed.

    // Pause action as soon as everything is loaded.
    document.getElementById("mainScene").addEventListener("loaded",
      function() {
        document.getElementById("go-button").style.display = "flex";
    });

    pressStart = function() {
      document.getElementById("splash").style.display = "none";
      document.getElementById("go-button").style.display = "none";

      // Load all the sounds and play-then-pause them all, to get them
      // permission to run under the iOS rules, which say that a sound
      // can only be played as a result of a user action.
      var sounds = document.getElementsByTagName('audio');

      for (i = 0; i < sounds.length; i++) {
        // console.log("playing, then pausing:", sounds[i]);
        var promise = sounds[i].play(); 

        if (promise) {
            //console.log("PLAYING:", promise);
            sounds[i].pause();
            sounds[i].currentTime = 0;

          promise.catch(function(e) { 
            console.log(e); 
            console.log(e.name); 
            console.log(e.message); 
            console.log(e.code); 
          });
        }      
      }

      var controllerComponent = document.querySelector('[controller]').components.controller;;
      controllerComponent.startTour();
    }
  </script>

  </body>
</html>